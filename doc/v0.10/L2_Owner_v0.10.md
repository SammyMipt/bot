# L2 ‚Äî UX‚Äë—Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è: Owner v0.10 (revD, —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –¥–ª—è UX‚Äë—Ä–µ–≤—å—é)

–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Å L1 v0.10 –∏ L3_Common v0.10. –£—á–∏—Ç—ã–≤–∞–µ—Ç –∫–æ–Ω—Ü–µ–ø—Ü–∏—é **master‚Äëuser**: –≤—Ö–æ–¥ Owner ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π entry point, –±–µ–∑ –≤—ã–±–æ—Ä–∞ —Ä–æ–ª–∏. –ö–Ω–æ–ø–∫–∏ —Ä–æ–ª–µ–π –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è **—Ç–æ–ª—å–∫–æ** –≤ —Ä–µ–∂–∏–º–µ –∏–º–ø–µ—Ä—Å–æ–Ω–∏–∑–∞—Ü–∏–∏.

---

## 0) –°–æ–≥–ª–∞—à–µ–Ω–∏—è –∏ –±–∞–∑–æ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞

- **Callback data (‚â§64B)**: –∫–æ—Ä–æ—Ç–∫–∏–µ action‚Äë–∫–æ–¥—ã + –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã. –î–ª—è –¥–ª–∏–Ω–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º **StateStore** —Å –∫–ª—é—á–æ–º `k=<uuid>`.
- **–í–µ–∑–¥–µ –¥–æ—Å—Ç—É–ø–Ω—ã** –∫–Ω–æ–ø–∫–∏: `‚¨ÖÔ∏è –ù–∞–∑–∞–¥`, `üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é`.
- **Dual TZ**: –≤—Å–µ –¥–∞—Ç—ã/–¥–µ–¥–ª–∞–π–Ω—ã –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∫–∞–∫ `TimeService.format_dual_tz(utc_dt, course_tz, user_tz)`.
- **Error registry**: –∫–æ–¥—ã –∏–∑ L3_Common (–≤–∫–ª—é—á–∞—è E_ACCESS_DENIED, E_STATE_INVALID, E_CONFIG_INVALID, E_STORAGE_IO, E_SIZE_LIMIT, E_TZ_INVALID).
- **Audit**: –∫–∞–∂–¥–æ–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –∂—É—Ä–Ω–∞–ª–∏—Ä—É–µ—Ç—Å—è —Å `{request_id}`.

### StateStore (–¥–ª—è –±–æ–ª—å—à–∏—Ö payload) ‚Äî –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ
- **TTL**: 15 –º–∏–Ω—É—Ç (900s).
- **JSON‚Äë—Å—Ç—Ä—É–∫—Ç—É—Ä–∞**:
  ```json
  {
    "role": "owner",
    "action": "ci|imp|mat|ar|rp|im|go|sp|as",
    "params": { "w":"W03", "t":"p", "id":"123", "csv_meta":{"rows":120} },
    "exp": 900
  }
  ```
- **–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å/–ø—Ä–æ—Å—Ä–æ—á–∫–∞**: –µ—Å–ª–∏ –∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω –ª–∏–±–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ ‚Üí `E_STATE_INVALID`, –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É ¬´–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞, –Ω–∞—á–Ω–∏—Ç–µ —à–∞–≥ –∑–∞–Ω–æ–≤–æ¬ª.

---

## 1) Entry point –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Owner

### Entry point (master‚Äëuser)
- –ü—Ä–∏ `/start` –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è **–Ω–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è** –ø—Ä–æ–≤–µ—Ä–∫–∞ `tg_id ‚àà TELEGRAM_OWNER_IDS` (–±–µ–∑ –≤—ã–±–æ—Ä–∞ —Ä–æ–ª–∏).
  - **–ù–µ—Ç** ‚Üí `E_ACCESS_DENIED`: ¬´‚õî –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω: —ç—Ç–æ—Ç –∞–∫–∫–∞—É–Ω—Ç –Ω–µ —É–ø–æ–ª–Ω–æ–º–æ—á–µ–Ω –∫–∞–∫ –≤–ª–∞–¥–µ–ª–µ—Ü.¬ª
  - **–î–∞** ‚Üí –µ—Å–ª–∏ –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω ‚Üí –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–æ–π—Ç–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é.

### –°—Ç–∞—Ä—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (—Ç–æ–ª—å–∫–æ –¥–ª—è Owner)
```
üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!
–í–∞—à Telegram ID –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω –∫–∞–∫ –≤–ª–∞–¥–µ–ª–µ—Ü –∫—É—Ä—Å–∞.
[–ù–∞—á–∞—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é]   (r=o;a=rg)
```

### FSM: OwnerRegistrationStates (Enum) + –ø–µ—Ä–µ—Ö–æ–¥—ã
```python
class OwnerRegistrationStates(Enum):
    verify_tg = auto()
    enter_fio = auto()
    enter_email = auto()
    ask_is_teacher = auto()
    enter_capacity = auto()
    confirm = auto()
    done = auto()
```
- `verify_tg ‚Üí enter_fio` (–µ—Å–ª–∏ tg –≤–∞–ª–∏–¥–µ–Ω)
- `enter_fio ‚Üí enter_email` (–≤–∞–ª–∏–¥–Ω—ã–π –≤–≤–æ–¥ ¬´–§–∞–º–∏–ª–∏—è –ò–º—è [–û—Ç—á–µ—Å—Ç–≤–æ]¬ª)
- `enter_email ‚Üí ask_is_teacher` (–≤–∞–ª–∏–¥–Ω—ã–π email)
- `ask_is_teacher ‚Üí enter_capacity | confirm` (–ø–æ –≤—ã–±–æ—Ä—É –î–∞/–ù–µ—Ç)
- `enter_capacity ‚Üí confirm` (—Ü–µ–ª–æ–µ –≤ –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö –≥—Ä–∞–Ω–∏—Ü–∞—Ö)
- `confirm.ok ‚Üí done`, `confirm.cancel ‚Üí enter_fio`
- **TTL 15 –º–∏–Ω** –Ω–∞ –ª—é–±–æ–π —Å—Ç–∞–¥–∏–∏ ‚Üí –≤–æ–∑–≤—Ä–∞—Ç –≤ `verify_tg` —Å –ø–æ–¥—Å–∫–∞–∑–∫–æ–π
- –õ—é–±–∞—è –æ—à–∏–±–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è ‚Üí `E_STATE_INVALID` –∏ –ø–æ–≤—Ç–æ—Ä —Ç–µ–∫—É—â–µ–≥–æ —à–∞–≥–∞

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: `User{role=owner, fio, email, tg_id, is_teacher}`; –æ–ø—Ü. `TeacherProfile{ weekly_limit }`.

**–ü–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏**:
- –ï—Å–ª–∏ `is_teacher=False` ‚Üí —Å—Ä–∞–∑—É **–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é Owner**.
- –ï—Å–ª–∏ `is_teacher=True` ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–≤–µ –∫–Ω–æ–ø–∫–∏:
  - `üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –≤–ª–∞–¥–µ–ª—å—Ü–∞`
  - `üìö –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è`

---

## 2) –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é Owner

```
‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—É—Ä—Å–æ–º
üë• –õ—é–¥–∏ –∏ —Ä–æ–ª–∏
üìö –ú–∞—Ç–µ—Ä–∏–∞–ª—ã –∫—É—Ä—Å–∞
üóÑÔ∏è –ê—Ä—Ö–∏–≤
üìä –û—Ç—á—ë—Ç—ã –∏ –∞—É–¥–∏—Ç
üë§ –ò–º–ø–µ—Ä—Å–æ–Ω–∏–∑–∞—Ü–∏—è
```
- Callback –∫–æ—Ä–Ω—è: `r=o;a=hm` (home)

---

## 3) Callback‚Äë–∫–æ–¥—ã (–∫–æ—Ä–æ—Ç–∫–∏–µ, —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ)

| –†–∞–∑–¥–µ–ª | –î–µ–π—Å—Ç–≤–∏–µ | –ü–∞—Ç—Ç–µ—Ä–Ω (‚â§64B) | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ |
|---|---|---|---|
| –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—É—Ä—Å–æ–º | –æ—Ç–∫—Ä—ã—Ç—å | `r=o;a=c` | course root |
| –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫—É—Ä—Å–∞ | —à–∞–≥ | `r=o;a=ci;s=p|u|c|d` | params / upload / confirm / done |
| –õ—é–¥–∏ –∏ —Ä–æ–ª–∏ | –æ—Ç–∫—Ä—ã—Ç—å | `r=o;a=lr` | people root |
| –ò–º–ø–æ—Ä—Ç | —Å—Ç–∞—Ä—Ç | `r=o;a=im;t=s|t` | s=students, t=teachers |
| –ü–æ–∏—Å–∫ –ø—Ä–æ—Ñ–∏–ª—è | –∑–∞–ø—Ä–æ—Å | `r=o;a=sp;k=<uuid>` | fio –≤ StateStore |
| –ú–∞—Ç—Ä–∏—Ü–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π | —à–∞–≥ | `r=o;a=as;s=p|c` | preview / commit; –¥–µ—Ç–∞–ª–∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ ‚Äî StateStore |
| –ú–∞—Ç–µ—Ä–∏–∞–ª—ã | –¥–µ–π—Å—Ç–≤–∏–µ | `r=o;a=mt;w=<Wxx>;t=p|m|n|s|v` | **m=teacher** (–º–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏–µ) ‚Äî –∫–æ–¥ **m** –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–µ–∑–¥–µ |
| –ê—Ä—Ö–∏–≤ | –æ—Ç–∫—Ä—ã—Ç—å | `r=o;a=ar;t=m|u` | m=materials, u=submissions |
| –û—Ç—á—ë—Ç—ã | —ç–∫—Å–ø–æ—Ä—Ç | `r=o;a=rp;t=a|g|x|c` | audit / grades / assignments / course |
| –ò–º–ø–µ—Ä—Å–æ–Ω–∏–∑–∞—Ü–∏—è | —Å—Ç–∞—Ä—Ç/–≤—ã—Ö–æ–¥ | `r=o;a=im` / `r=o;a=ix` | start / exit |
| Grade override | –∏–∑–º–µ–Ω–µ–Ω–∏–µ | `r=o;a=go;k=<uuid>` | –≤—Å–µ–≥–¥–∞ —á–µ—Ä–µ–∑ StateStore |

> –õ—é–±—ã–µ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –¥–ª–∏–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (fio, —Ñ–∏–ª—å—Ç—Ä—ã, –º–∞—Å—Å–∏–≤—ã id) ‚Äî **—Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ `k=<uuid>`**.

---

## 4) –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—É—Ä—Å–æ–º

### 4.1 –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫—É—Ä—Å–∞ (–¥–≤—É—Ö—à–∞–≥–æ–≤–∞—è)
**FSM: CourseInitStates**
```python
class CourseInitStates(Enum):
    enter_params = auto()   # s=p
    upload_csv = auto()     # s=u
    confirm = auto()        # s=c
    done = auto()           # s=d
```
**–ü–µ—Ä–µ—Ö–æ–¥—ã**: `enter_params ‚Üí upload_csv ‚Üí confirm ‚Üí done`
**TTL**: 15 –º–∏–Ω –Ω–∞ –∫–∞–∂–¥—ã–π —ç—Ç–∞–ø; –ø–æ TTL ‚Äî –≤–æ–∑–≤—Ä–∞—Ç –∫ `enter_params`.

- `params (s=p)`: –Ω–∞–∑–≤–∞–Ω–∏–µ, –æ–ø–∏—Å–∞–Ω–∏–µ, —è–∑—ã–∫, course_tz (–≤–∞–ª–∏–¥–Ω—ã–π tz –∏–ª–∏ `E_TZ_INVALID`).
- `upload (s=u)`: `weeks.csv` ‚Äî **—Å—Ç—Ä–æ–≥–∏–π —Ñ–æ—Ä–º–∞—Ç** –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤:
  - `week_id,topic,description,deadline`
  - –î–æ–ø. –∫–æ–ª–æ–Ω–∫–∏ ‚Üí `E_CSV_SCHEMA`
  - –ü—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ ‚Üí –∏–≥–Ω–æ—Ä
  - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ UTF‚Äë8 BOM
  - –î–µ–¥–ª–∞–π–Ω—ã –ø–∞—Ä—Å–∏–º; –æ—à–∏–±–∫–∏ ‚Üí `E_DEADLINE_PARSE`
- `confirm (s=c)`: –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –Ω–µ–¥–µ–ª—å, –¥–µ–¥–ª–∞–π–Ω—ã –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ **Dual TZ**.
- `done (s=d)`: —Ñ–∏–∫—Å–∞—Ü–∏—è. –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å: –ø–æ–≤—Ç–æ—Ä–Ω—ã–π commit –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ‚Üí no‚Äëop.

**Audit**: `OWNER_COURSE_UPDATE`, `{request_id}`.

---

## 5) –õ—é–¥–∏ –∏ —Ä–æ–ª–∏

### 5.1 –ò–º–ø–æ—Ä—Ç CSV
**FSM: ImportStates**
```python
class ImportStates(Enum):
    choose_type = auto()
    upload_file = auto()
    validate = auto()
    confirm = auto()
    done = auto()
```
**–ü–µ—Ä–µ—Ö–æ–¥—ã**: `choose_type ‚Üí upload_file ‚Üí validate ‚Üí confirm ‚Üí done`
**TTL**: 15 –º–∏–Ω; –ø–æ TTL ‚Äî –≤–æ–∑–≤—Ä–∞—Ç –∫ `choose_type`.

- `students.csv` ‚Äî –∑–∞–≥–æ–ª–æ–≤–∫–∏ **—Å—Ç—Ä–æ–≥–æ**: `surname,name,patronymic,group,lms_email`
- `teachers.csv` ‚Äî –∑–∞–≥–æ–ª–æ–≤–∫–∏ **—Å—Ç—Ä–æ–≥–æ**: `surname,name,patronymic,weekly_limit`
- –î–æ–ø. –∫–æ–ª–æ–Ω–∫–∏ ‚Üí `E_CSV_SCHEMA`
- –ü—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ ‚Üí –∏–≥–Ω–æ—Ä
- UTF‚Äë8 BOM ‚Üí –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
- –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ç—Ä–æ–∫ —Å –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ–º –æ—à–∏–±–æ–∫; –æ—Ç—á—ë—Ç –ø–æ `row_count / errors_count`

**Callback**: `r=o;a=im;t=s|t` (—Ç–∏–ø), —Ñ–∞–π–ª—ã –∏ –æ—Ç—á—ë—Ç—ã ‚Äî —á–µ—Ä–µ–∑ `k=<uuid>`.

**Idempotency**: –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∏–º–ø–æ—Ä—Ç **—Ç–æ–≥–æ –∂–µ** —Ñ–∞–π–ª–∞ (–ø–æ checksum —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ) ‚Üí no‚Äëop.

**Audit**: `OWNER_UPLOAD_STUDENTS | OWNER_UPLOAD_TEACHERS`, `{request_id}`.

### 5.2 –ü–æ–∏—Å–∫ –∏ –ø—Ä–æ—Ñ–∏–ª—å
- –ü–æ–∏—Å–∫ –ø–æ —Ñ–∞–º–∏–ª–∏–∏ (prefix) ‚Üí `r=o;a=sp;k=<uuid>`
- –ö–∞—Ä—Ç–æ—á–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è: –§–ò–û, email, —Ä–æ–ª—å, –≥—Ä—É–ø–ø–∞/–ª–∏–º–∏—Ç, –∏—Å—Ç–æ—Ä–∏—è —Å–¥–∞—á, —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ –æ—Ü–µ–Ω–∫–∏.

### 5.3 –ú–∞—Ç—Ä–∏—Ü–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π (Assignment)
- –ê–≤—Ç–æ–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ **round‚Äërobin**.
- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä CSV: **—Å—Ç—É–¥–µ–Ω—Ç—ã √ó –Ω–µ–¥–µ–ª–∏ ‚Üí –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–∏**.
- Callback: `r=o;a=as;s=p|c` (preview/commit). –î–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–µ–≤—å—é ‚Äî —á–µ—Ä–µ–∑ `k=<uuid>`.
- Audit: `OWNER_ASSIGN_PREVIEW / OWNER_ASSIGN_COMMIT` —Å `{request_id}`.

---

## 6) –ú–∞—Ç–µ—Ä–∏–∞–ª—ã –∫—É—Ä—Å–∞ (–ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏)

### –¢–∏–ø—ã (—Å—Ç—Ä–æ–≥–æ –ø–æ L1) –∏ –∫–æ–¥—ã
- üìñ `p` ‚Äî –î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞—á–∏ –∏ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ (**prep**)
- üìò `m` ‚Äî –ú–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (**teacher**) ‚Äî **–∫–æ–¥ m –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–µ–∑–¥–µ**
- üìù `n` ‚Äî –ö–æ–Ω—Å–ø–µ–∫—Ç—ã
- üìä `s` ‚Äî –ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏
- üé• `v` ‚Äî –ó–∞–ø–∏—Å–∏ –ª–µ–∫—Ü–∏–π

**FSM: MaterialUploadStates**
```python
class MaterialUploadStates(Enum):
    pick_week = auto()
    pick_type = auto()
    upload_file = auto()
    confirm = auto()
    done = auto()
```
**–ü–µ—Ä–µ—Ö–æ–¥—ã**: `pick_week ‚Üí pick_type ‚Üí upload_file ‚Üí confirm ‚Üí done`
**TTL**: 15 –º–∏–Ω; –ø–æ TTL ‚Äî –≤–æ–∑–≤—Ä–∞—Ç –∫ `pick_week`.

**Callback**: `r=o;a=mt;w=<Wxx>;t=p|m|n|s|v`
–§–∞–π–ª—ã/—Å—Å—ã–ª–∫–∏ –∏ –¥–ª–∏–Ω–Ω—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ ‚Äî —á–µ—Ä–µ–∑ `k=<uuid>`.

**–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤**
- –ù–∞ –æ–¥–Ω—É –Ω–µ–¥–µ–ª—é –∏ —Ç–∏–ø ‚Äî **–æ–¥–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞—è –≤–µ—Ä—Å–∏—è**.
- –ù–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞: —Å—Ç–∞—Ä–∞—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ ‚Üí **–∞—Ä—Ö–∏–≤** (–∏—Å—Ç–æ—Ä–∏—è –≤–µ—Ä—Å–∏–π).
- **–õ–∏–º–∏—Ç –∞—Ä—Ö–∏–≤–∞**: –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é **20 –≤–µ—Ä—Å–∏–π –Ω–∞ (week,type)** (–∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º–æ).
- **–ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞**: –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞ ‚Äî —É–¥–∞–ª–µ–Ω–∏–µ **—Å–∞–º—ã—Ö —Å—Ç–∞—Ä—ã—Ö** –≤–µ—Ä—Å–∏–π –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –±—ç–∫–∞–ø–∞ (—Å–º. ¬ß8).

**Idempotency**: –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ **–∏–¥–µ–Ω—Ç–∏—á–Ω–æ–≥–æ** —Ñ–∞–π–ª–∞ (–ø–æ checksum) ‚Üí no‚Äëop.

**Audit**: `OWNER_MATERIAL_UPLOAD / OWNER_MATERIAL_ARCHIVE / OWNER_MATERIAL_DELETE` + `{request_id}`.

---

## 7) –ê—Ä—Ö–∏–≤

- **–ú–∞—Ç–µ—Ä–∏–∞–ª—ã**: `r=o;a=ar;t=m;w=<Wxx>` (–¥–µ—Ç–∞–ª–∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ ‚Äî `k=<uuid>`).
- **–†–µ—à–µ–Ω–∏—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤**: `r=o;a=ar;t=u;k=<uuid>` (fio/id –∏ —Ñ–∏–ª—å—Ç—Ä—ã –≤ StateStore).
- –î–µ–π—Å—Ç–≤–∏—è: ¬´üìÇ –°–∫–∞—á–∞—Ç—å –≤—Å—ë / üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—Å—ë¬ª (—Ç–æ–ª—å–∫–æ –∏–∑ –∞—Ä—Ö–∏–≤–∞).
- –û—à–∏–±–∫–∏: `E_NOT_FOUND`, `E_STORAGE_IO`.

---

## 8) –û—Ç—á—ë—Ç—ã, –∞—É–¥–∏—Ç –∏ –±—ç–∫–∞–ø

- –≠–∫—Å–ø–æ—Ä—Ç AuditLog: `r=o;a=rp;t=a`
- –≠–∫—Å–ø–æ—Ä—Ç –æ—Ü–µ–Ω–æ–∫ (—Ñ–∏–Ω–∞–ª—å–Ω—ã—Ö): `r=o;a=rp;t=g`
- –≠–∫—Å–ø–æ—Ä—Ç assignment matrix (–∞–∫—Ç–∏–≤–Ω–æ–π): `r=o;a=rp;t=x`
- –≠–∫—Å–ø–æ—Ä—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∫—É—Ä—Å–∞ (weeks/materials): `r=o;a=rp;t=c`

**–ë—ç–∫–∞–ø**:
- –ü–ª–∞–Ω–æ–≤—ã–π: **–µ–∂–µ–¥–Ω–µ–≤–Ω–æ 03:00 UTC** ‚Üí —Å–æ–±—ã—Ç–∏–µ `SYSTEM_BACKUP_DAILY_COMMIT`.
- –í—Ä—É—á–Ω—É—é (–∫–Ω–æ–ø–∫–∞ ¬´üì¶ –ó–∞–ø—É—Å—Ç–∏—Ç—å –±—ç–∫–∞–ø —Å–µ–π—á–∞—Å¬ª –¥–æ—Å—Ç—É–ø–Ω–∞ –≤–Ω–µ impersonation): `r=o;a=rp;t=b` ‚Üí —Ç—Ä–∏–≥–≥–µ—Ä —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –¥–∂–æ–±–∞.

**Audit —Å–æ–±—ã—Ç–∏—è**: `OWNER_AUDIT_EXPORT / OWNER_REPORT_EXPORT / SYSTEM_BACKUP_DAILY_COMMIT` (+ `{request_id}`).

**–î–æ–ø. toasts/edge cases**:
- ‚ö†Ô∏è ¬´–§–∞–π–ª –∏–¥–µ–Ω—Ç–∏—á–µ–Ω –∞–∫—Ç–∏–≤–Ω–æ–π –≤–µ—Ä—Å–∏–∏ ‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–ø—É—â–µ–Ω–∞¬ª
- ‚ö†Ô∏è ¬´–ò–º–ø–æ—Ä—Ç –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è –ø–æ checksum ‚Äî –ø—Ä–æ–ø—É—â–µ–Ω–æ¬ª
- ‚ö†Ô∏è ¬´–õ–∏—à–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏ CSV ‚Äî —Å—Ç—Ä–æ–∫–∞ –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∞¬ª
- ‚ö†Ô∏è ¬´–£–¥–∞–ª–µ–Ω—ã —Å—Ç–∞—Ä—ã–µ –∞—Ä—Ö–∏–≤–Ω—ã–µ –≤–µ—Ä—Å–∏–∏: N¬ª
- ‚õî ¬´–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ –≤ —Ä–µ–∂–∏–º–µ –∏–º–ø–µ—Ä—Å–æ–Ω–∏–∑–∞—Ü–∏–∏¬ª
- ‚úÖ ¬´–ë—ç–∫–∞–ø –∑–∞–ø—É—â–µ–Ω¬ª / ‚õî ¬´–ë—ç–∫–∞–ø –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω¬ª

---

## 9) –ò–º–ø–µ—Ä—Å–æ–Ω–∏–∑–∞—Ü–∏—è (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)

- Start: `r=o;a=im` ‚Üí –≤–≤–µ—Å—Ç–∏ `tg_id` –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
  - –ù–µ –Ω–∞–π–¥–µ–Ω ‚Üí `E_NOT_FOUND`.
  - **Owner‚ÜíOwner** –ø–æ–ø—ã—Ç–∫–∞ ‚Üí `E_ACCESS_DENIED` (–∑–∞–ø—Ä–µ—â–µ–Ω–æ).

**–ü–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞**:
- –ë–µ–π–¥–∂: `IMPERSONATING: <fio> (<role>)` (–≤–∏–¥–µ–Ω –Ω–∞ –≤—Å–µ—Ö —ç–∫—Ä–∞–Ω–∞—Ö).
- –í –º–µ–Ω—é Owner **–∑–∞–º–µ–Ω—è–µ–º** ¬´–ò–º–ø–µ—Ä—Å–æ–Ω–∏–∑–∞—Ü–∏—è¬ª –Ω–∞ ¬´‚Ü©Ô∏è –ó–∞–≤–µ—Ä—à–∏—Ç—å –∏–º–ø–µ—Ä—Å–æ–Ω–∏–∑–∞—Ü–∏—é¬ª (`r=o;a=ix`).
- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ —Ä–æ–ª–∏:
  - –ï—Å–ª–∏ –∏–º–ø–µ—Ä—Å–æ–Ω–∏—Ä–æ–≤–∞–Ω **–ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å**: `[üìö –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è]`
  - –ï—Å–ª–∏ –∏–º–ø–µ—Ä—Å–æ–Ω–∏—Ä–æ–≤–∞–Ω **—Å—Ç—É–¥–µ–Ω—Ç**: `[üéì –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —Å—Ç—É–¥–µ–Ω—Ç–∞]`

**–ú–∞—Ç—Ä–∏—Ü–∞ –ø—Ä–∞–≤ (—Å–≤–æ–¥–Ω–æ)**:
- **–†–∞–∑—Ä–µ—à–µ–Ω–æ**: —á—Ç–µ–Ω–∏–µ –ª—é–±—ã—Ö –æ—Ç—á—ë—Ç–æ–≤/–º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤, –ø—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–æ—Ñ–∏–ª–µ–π, —ç–∫—Å–ø–æ—Ä—Ç (–∫—Ä–æ–º–µ –±—ç–∫–∞–ø–∞).
- **–ó–∞–ø—Ä–µ—â–µ–Ω–æ**: –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫—É—Ä—Å–∞, –±—ç–∫–∞–ø/restore, –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω—ã–µ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ –∞—Ä—Ö–∏–≤–∞, –∏–∑–º–µ–Ω–µ–Ω–∏–µ assignment matrix, –∑–∞–≥—Ä—É–∑–∫–∞/—É–¥–∞–ª–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤.

**Audit**: `DEV_IMPERSONATE_START / DEV_IMPERSONATE_COMMIT / DEV_IMPERSONATE_EXIT` (+ `{request_id}`).

---

## 10) Override –æ—Ü–µ–Ω–æ–∫ (–ø—Ä–∞–≤–æ Owner)

- –í –∫–∞—Ä—Ç–æ—á–∫–µ —Å—Ç—É–¥–µ–Ω—Ç–∞ ‚Üí ¬´‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å / ‚ûï –î–æ–±–∞–≤–∏—Ç—å –æ—Ü–µ–Ω–∫—É¬ª.
- –í—Å–µ–≥–¥–∞ —á–µ—Ä–µ–∑ StateStore: `r=o;a=go;k=<uuid>` (`params`: `{student_id, week, score, letter, comment}`).
- –ù–∞ —Å—Ç–æ—Ä–æ–Ω–µ Student –≤–∏–¥–Ω–∞ **—Ñ–∏–Ω–∞–ª—å–Ω–∞—è** –æ—Ü–µ–Ω–∫–∞ (override –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–µ–µ).
- Audit: `OWNER_GRADE_OVERRIDE` (+ `{request_id}`).

---

## 11) Idempotency

- –ò–º–ø–æ—Ä—Ç CSV: –ø–æ checksum —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ ‚Äî –ø–æ–≤—Ç–æ—Ä ‚Üí no‚Äëop.
- –ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤: –ø–æ checksum ‚Äî –ø–æ–≤—Ç–æ—Ä ‚Üí no‚Äëop.
- Course init commit: –ø–æ–≤—Ç–æ—Ä –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ‚Äî no‚Äëop.
- –ò–º–ø–µ—Ä—Å–æ–Ω–∏–∑–∞—Ü–∏—è: –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è —Ç–æ–≥–æ –∂–µ tg_id ‚Äî no‚Äëop; –≤—ã—Ö–æ–¥ ‚Äî –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–µ–Ω.

---

## 12) –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ (UX‚Äë—É—Ä–æ–≤–µ–Ω—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π, –¥–æ–ø–æ–ª–Ω–µ–Ω–æ)

- `CourseRepository`:
  - `create_or_update(params)`
  - `list_weeks()`
  - `transaction()`  ‚Üê **–∞—Ç–æ–º–∞—Ç–∏—á–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏**
- `UserRepository`:
  - `import_students(csv, request_id)`
  - `import_teachers(csv, request_id)`
  - `search_by_fio(prefix)`
  - `transaction()`
  - `import_exists(checksum) -> bool`  ‚Üê –¥–ª—è –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –∏–º–ø–æ—Ä—Ç–∞
- `MaterialRepository`:
  - `upload(week, type_, file_bytes, request_id)`
  - `archive(material_id)`
  - `delete(material_id)`
  - `history(week, type_)`
  - `get_by_checksum(week, type_, checksum)`  ‚Üê **–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤**
  - `transaction()`
- `AssignmentRepository`:
  - `preview_matrix()`
  - `commit_matrix(request_id)`
  - `transaction()`

---

## 13) –ù–∞–≤–∏–≥–∞—Ü–∏—è –∏ toasts (—Ä–∞—Å—à–∏—Ä–µ–Ω–æ)

- –í—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω—ã: `‚¨ÖÔ∏è –ù–∞–∑–∞–¥`, `üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é`.
- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è:
  - ‚úÖ ¬´–ö—É—Ä—Å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω¬ª
  - ‚úÖ ¬´–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω: X —Å—Ç—Ä–æ–∫, –æ—à–∏–±–æ–∫ Y¬ª
  - ‚úÖ ¬´–ú–∞—Ç—Ä–∏—Ü–∞ —Å–æ–∑–¥–∞–Ω–∞¬ª
  - ‚úÖ ¬´–ú–∞—Ç–µ—Ä–∏–∞–ª –∑–∞–≥—Ä—É–∂–µ–Ω / –≤–µ—Ä—Å–∏—è –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∞¬ª
  - ‚úÖ ¬´–ë—ç–∫–∞–ø –∑–∞–ø—É—â–µ–Ω¬ª
  - ‚ö†Ô∏è ¬´–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞, –Ω–∞—á–Ω–∏—Ç–µ —à–∞–≥ –∑–∞–Ω–æ–≤–æ¬ª
  - ‚õî ¬´–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ –≤ —Ä–µ–∂–∏–º–µ –∏–º–ø–µ—Ä—Å–æ–Ω–∏–∑–∞—Ü–∏–∏¬ª
