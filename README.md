# Edu Bot — учебный Telegram-бот

Edu Bot — каркас многоуровневого Telegram-бота для учебных ассистентов. Проект построен на aiogram 3 и SQLite и включает готовые сценарии регистрации, управления материалами и взаимодействия студентов, преподавателей и владельцев курса.

## Возможности
- Регистрация пользователей с ролями Student, Teacher и Owner с контролем доступа через middleware.
- Демонстрация state store и callback-паттернов для aiogram, включая `/demo` и многошаговые меню.
- Управление недельными материалами, загрузкой работ студентов и версиями файлов.
- Бронирование слотов приемки, история попыток и автоматическое уведомление об ошибках.
- Автоматические резервные копии и очистка просроченных состояний, инструменты для работы с базой.
- Набор CLI-команд и скриптов для миграций, сидов, тестов и служебных задач.

## Структура проекта
```
.
├── app/
│   ├── bot/              # Telegram-роутеры, middleware и UI-слои по ролям
│   ├── core/             # Доменная логика, конфигурация, бэкапы, файловый слой
│   ├── db/               # Соединение с SQLite и репозитории
│   └── services/         # Вспомогательные сервисы (форматирование времени и т.п.)
├── migrations/           # SQL-миграции (001_*.sql ...)
├── scripts/              # CLI-скрипты: migrate, seed, doctor, cleanup_state
├── tests/                # Pytest-тесты для команд и UI-слоев
├── var/                  # Локальные данные: app.db, материалы, submissions, бэкапы
├── doc/                  # Спецификации и сценарии по эпикам
├── Makefile              # Основные команды разработчика
├── pyproject.toml        # Настройки Poetry, зависимостей и линтеров
└── .env*                 # Конфигурация окружения (пример и тестовые значения)
```

## Требования
- Python 3.10–3.12 (проект тестировался на 3.12).
- Poetry 1.6+ для управления зависимостями.
- GNU Make (используется Makefile).
- SQLite3 CLI (опционально, для ручных проверок и резервных копий).
- Действующий Telegram Bot Token и Telegram ID владельца курса.

## Быстрый старт
```bash
# 1. Установите зависимости и подготовьте каталоги var/
make init

# 2. Создайте .env и заполните ключевые переменные
cp .env.example .env
$EDITOR .env  # заполните TELEGRAM_TOKEN, OWNERS_TELEGRAM_ID, COURSE_SECRET

# 3. Проверьте окружение
make doctor

# 4. Примените миграции и загрузите начальные данные
make migrate
make seed  # создаст владельца и первую учебную неделю

# 5. Запустите бота
make run-bot
```

После запуска бот работает через long polling и подключается к Telegram c токеном из `.env`.

## Конфигурация (.env)
| Переменная | Значение по умолчанию | Описание |
| --- | --- | --- |
| `APP_ENV` | `dev` | Режим работы (dev/test/prod) влияет на логи и пути. |
| `TELEGRAM_TOKEN` | пусто | Токен бота от BotFather. Без него бот не стартует. |
| `OWNERS_TELEGRAM_ID` | пусто | Список ID владельцев, разделенных `,` или `;`. Нужен для регистрации владельца. |
| `COURSE_SECRET` | пусто | Секрет для регистрации преподавателей. Совпадает со сценариями курса. |
| `DATA_DIR` | `./var` | Корневая директория данных: БД, материалы, бэкапы. |
| `SQLITE_PATH` | `./var/app.db` | Путь к SQLite. Можно указать абсолютный путь. |
| `MAX_FILE_MB` | `20` | Ограничение размера файлов, принимаемых ботом. |
| `TZ` | `UTC` | Часовой пояс приложения. Влияет на формат времени. |

Для тестового окружения используйте `.env.test`. Команды `make run-bot-test` и `make test-env` автоматически подгружают значения из обоих файлов.

## Запуск и режимы
- `make run-bot` — запустить бота в dev-режиме с переменными из `.env`.
- `make run-bot-test` — запустить с `.env` + `.env.test`, отдельной БД (`var/test/app.db`) и директориями.
- Альтернатива без make: `poetry run python -m app.bot.main`.

Бот подключает все роутеры в `app/bot/` (регистрация, UI по ролям, демо, команды владельца/преподавателя/студента). Middleware проверяет роль пользователя по БД (`app/db/repo_users.py`).

## Миграции и база данных
- SQL-миграции лежат в `migrations/NNN_name.sql` и применяются в алфавитном порядке.
- `make migrate` или `poetry run python scripts/migrate.py` создают/обновляют БД (`var/app.db`).
- `make seed` добавляет владельца (ID задайте через `SEED_OWNER_TG_ID` или `.env`) и первую неделю курса.
- `make clean-db` очищает только dev-базу, `make clean-test-db` — тестовую.
- Для переноса dev-БД в тест: `make test-db-from-prod`. Создание снапшота: `make test-backup`.

## Данные и резервные копии
- Рабочие данные сохраняются в `var/`: `materials/`, `submissions/`, `exports/`, `logs/`, `tmp/`, `app.db`.
- Автоматический бэкап запускается ежедневно в 03:00 UTC (`periodic_backup_daily`). Владелец может инициировать бэкап вручную из UI (см. `app/bot/ui_owner_stub.py`).
- Для ручной проверки свежести бэкапов используйте `/backup status` в владельческом меню или вызывайте `trigger_backup()` из REPL.
- Скрипт `scripts/cleanup_state.py` очищает протухшие записи state-store (`make state-clean` в Makefile).

## Тестирование и качество
- `make test` — запускает pytest (asyncio тесты включены).
- `make cov-summary` — pytest с покрытием и отчетом по пропущенным строкам.
- `make lint` — flake8 для каталога `app/`.
- `make lint-ci` — isort/black в режиме проверки + flake8 по всему проекту.
- `make fmt` — автоформатирование `app/` и `tests/` через black + isort.
- Установите pre-commit хуки: `poetry run pre-commit install` (конфиг в `.pre-commit-config.yaml`).

## Работа с несколькими окружениями
- `make test-env` — создаст каталоги `var/test`, подготовит БД и миграции для тестов.
- `make doctor` — проверит наличие `.env`, права на каталоги `var/`, версии инструментов.
- Для CI можно использовать `make ci` (линт, миграции, тесты, отчет покрытия).

## Команды бота
- `/start` и `/register` — регистрация пользователя в зависимости от роли. Владелец видит инициализацию курса, студенты — выбор роли.
- `/help` — краткая справка и список доступных команд.
- `/whoami` — текущая роль и профиль пользователя.
- `/demo` — демонстрирует state-store и callback-кнопки (EPIC-2).
- Меню владельца/преподавателя/студента реализуют работу с материалами, брошюрами, оценками, слоты сдачи и управление файлами (см. `app/bot/ui_*_stub.py`).

## Полезные материалы
- Каталог `doc/` содержит сценарии и требования по эпикам (`v0.10`, `v0.11`).
- `scripts/migrate.py`, `scripts/seed.py`, `scripts/cleanup_state.py` можно запускать через `poetry run python ...`.
- Типовые ответы ошибок и UX-сценарии описаны внутри UI-модулей (например, `app/bot/ui_student_stub.py`).

Готово! После настройки подпишите бота на нужный чат, выдайте токен и добавьте владельца в `OWNERS_TELEGRAM_ID`. Теперь можно тестировать учебные сценарии и дописывать логику под ваш курс.
